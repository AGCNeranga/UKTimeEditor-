<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VIP RAFFLE-ELIGIBLE RACES</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-image: url('https://wallpapercat.com/w/full/b/b/8/2131817-2560x1600-desktop-hd-horse-racing-wallpaper-photo.jpg');
      filter: brightness(85%);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .overlay {
      background-color: rgba(0, 0, 0, 0.4);
      flex: 3;
      padding-top: 60px;
      padding-bottom: 60px;
    }

    .password-screen {
      max-width: 485px;
      margin: 100px auto;
      padding: 35px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 15px #00FF00;
      text-align: center;
    }

    .password-screen input {
      margin-top: 20px;
    }

    .container-main {
      display: none;
      animation: fadeIn 1s ease-in-out;
    }

    .race-block {
      background: rgba(33, 37, 41, 0.9);
      color: white;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 5px solid #ffc107;
      border-radius: 8px;
      font-family: monospace;
    }

    .race-meeting {
      font-weight: 700;
      font-size: 1.2rem;
      color: #ffc107;
    }

    .race-number {
      color: #28a745;
      font-weight: bold;
    }

    .race-time {
      color: #17a2b8;
      font-weight: bold;
    }

    .race-prize {
      color: #ffc107;
      font-weight: bold;
    }

    textarea, input {
      background-color: rgba(255, 255, 255, 0.9) !important;
    }

    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }

    footer {
      text-align: center;
      color: #ffc107;
      padding: 15px;
      background: rgba(20, 20, 20, 0.85);
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div id="passwordScreen" class="password-screen">
      <h2 class="text-warning mb-3">VIP RAFFLE-ELIGIBLE RACES</h2>
      <img src="b1.jpg" width="155" />
      <input type="password" id="password" class="form-control" placeholder="Enter Password..." />
      <button class="btn btn-warning mt-3" onclick="checkPassword()">Unlock Premium Access</button>
    </div>

    <div class="container container-main" id="mainContent">
      <h2 class="text-light mb-4">Premium Race Selection Dashboard</h2>

      <textarea id="raceText" rows="15" class="form-control mb-3" placeholder="Paste race card text here..."></textarea>

      <input type="text" id="meetingsInput" class="form-control mb-3" placeholder="Enter meeting names (comma separated)" />
      <small class="text-light">Only races from these meetings will be shown. Leave empty to show all.</small>

      <div class="row mb-3 mt-3">
        <div class="col">
          <input type="number" id="minPrize" class="form-control" placeholder="Min Prize (£)" />
        </div>
        <div class="col">
          <input type="number" id="maxPrize" class="form-control" placeholder="Max Prize (£)" />
        </div>
      </div>

      <div class="d-flex gap-2 mb-4">
        <button class="btn btn-success" onclick="processText()">Process & Filter</button>
        <button class="btn btn-danger" onclick="clearAll()">Clear All</button>
      </div>

      <div id="output"></div>
    </div>
  </div>

  <footer>
    <p>Copyright © 2025 Charith Neranga. All rights reserved.</p>
  </footer>

  <script>
    document.getElementById("password").addEventListener("keypress", function (e) {
      if (e.key === "Enter") checkPassword();
    });

    function checkPassword() {
      const entered = document.getElementById("password").value;
      if (entered === "lal1234") {
        document.getElementById("passwordScreen").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
      } else {
        alert("Incorrect password!");
      }
    }

    function escapeHtml(text) {
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;");
    }

    function clearAll() {
      document.getElementById('raceText').value = '';
      document.getElementById('meetingsInput').value = '';
      document.getElementById('minPrize').value = '';
      document.getElementById('maxPrize').value = '';
      document.getElementById('output').innerHTML = '';
    }

    function processText() {
      const text = document.getElementById('raceText').value;
      const output = document.getElementById('output');
      const minPrize = parseInt(document.getElementById('minPrize').value || 0);
      const maxPrize = parseInt(document.getElementById('maxPrize').value || 9999999);

      const meetingsRaw = document.getElementById('meetingsInput').value;
      const meetingsFilter = meetingsRaw
        ? meetingsRaw.split(',').map(m => m.trim().toUpperCase()).filter(m => m.length > 0)
        : [];

      if (!text.trim()) {
        alert('Please paste race card text first.');
        return;
      }

      const lines = text.split(/\r?\n/);

      let currentMeeting = 'Unknown';
      let raceNumberCounter = 0; // For races without explicit number
      let races = [];

      // UPDATED regex to allow AWS, AWSR, AWSR /1, Hm/6 etc.
      const explicitRaceLineRegex = /^([\w]+(?:\s*\/\s*\d+)?)[\s]+(\d{1,2}[—:]\d{2})/;
      const timeOnlyLineRegex = /^\d{1,2}[—:]\d{2}$/;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        // Detect meeting name: uppercase line <=30 chars, no digits, no £ sign
        if (/^[A-Z\s\-']{1,30}$/.test(line) && !line.match(/\d/) && !line.includes('£')) {
          currentMeeting = line;
          raceNumberCounter = 0; // reset for new meeting
          continue;
        }

        // Check if explicit race line
        let explicitMatch = line.match(explicitRaceLineRegex);
        if (explicitMatch) {
          const raceNumber = explicitMatch[1].trim();  // Keep full code like AWSR /1
          const ukTime = explicitMatch[2];

          let slTime = 'N/A';
          let raceName = '';
          let prize = 0;

          // Look ahead up to next 10 lines
          for (let j = i + 1; j < Math.min(i + 10, lines.length); j++) {
            const l = lines[j].trim();

            // SL time in parentheses, e.g. (07:42)
            if (slTime === 'N/A' && /^\(?\d{1,2}[:.]\d{2}\)?$/.test(l)) {
              slTime = l.replace(/[()]/g, '');
            }

            // Race name: first non-empty line > 5 chars without £ or time pattern
            if (!raceName && l.length > 5 && !l.includes('£') && !/^\(?\d{1,2}[.:]\d{2}\)?$/.test(l)) {
              raceName = l;
            }

            // Prize
            if (!prize) {
              const pMatch = l.match(/£([\d,]+)/);
              if (pMatch) prize = parseInt(pMatch[1].replace(/,/g, ''));
            }

            if (slTime !== 'N/A' && raceName && prize) break;
          }

          if (meetingsFilter.length && !meetingsFilter.includes(currentMeeting.toUpperCase())) {
            continue;
          }

          if (prize >= minPrize && prize <= maxPrize) {
            races.push({
              meeting: currentMeeting,
              raceNumber,
              ukTime,
              rawSLTime: slTime,
              raceName,
              prize
            });
          }
          continue;
        }

        // Check if time-only line (race without explicit number)
        if (timeOnlyLineRegex.test(line)) {
          raceNumberCounter++;
          const ukTime = line;

          // SL time in next line (optional)
          let slTime = 'N/A';
          if (i + 1 < lines.length && /^\(\d{1,2}\.\d{2}\)$/.test(lines[i + 1].trim())) {
            slTime = lines[i + 1].trim().slice(1, -1);
            i++; // skip SL time line
          }

          // Next lines: race name
          let raceName = '';
          let j = i + 1;
          while (j < lines.length && lines[j].trim().length < 100) {
            const candidate = lines[j].trim();
            if (candidate.length > 5 && !candidate.includes('£') && !/^\(?\d{1,2}[.:]\d{2}\)?$/.test(candidate)) {
              raceName = candidate;
              break;
            }
            j++;
          }

          // Find prize in next 10 lines
          let prize = 0;
          for (let k = j; k < Math.min(j + 10, lines.length); k++) {
            const pMatch = lines[k].match(/£([\d,]+)/);
            if (pMatch) {
              prize = parseInt(pMatch[1].replace(/,/g, ''));
              break;
            }
          }

          if (meetingsFilter.length && !meetingsFilter.includes(currentMeeting.toUpperCase())) {
            continue;
          }

          if (prize >= minPrize && prize <= maxPrize) {
            races.push({
              meeting: currentMeeting,
              raceNumber: raceNumberCounter.toString(),
              ukTime,
              rawSLTime: slTime,
              raceName,
              prize
            });
          }
          continue;
        }
      } // end for lines

      if (races.length === 0) {
        output.innerHTML = '<p class="text-warning">No races found for the selected criteria.</p>';
        return;
      }

      // Sort by SL time if possible, fallback to large number
      races.sort((a, b) => {
        const timeToMinutes = t => {
          if (t === 'N/A') return 9999;
          const parts = t.split(/[:.]/).map(Number);
          return (parts[0] || 0) * 60 + (parts[1] || 0);
        };
        return timeToMinutes(a.rawSLTime) - timeToMinutes(b.rawSLTime);
      });

      output.innerHTML = races.map(r => `
        <div class="race-block">
          <div class="race-meeting">Race Course: ${r.meeting}</div>
          <div class="race-number">Race Number: ${r.raceNumber}</div>
          <div class="race-time">UK Time: ${r.ukTime}</div>
          <div class="race-time">SL Time: ${r.rawSLTime}</div>
          <div>Race Name: ${escapeHtml(r.raceName)}</div>
          <div class="race-prize">Prize Money: £${r.prize.toLocaleString()}</div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
